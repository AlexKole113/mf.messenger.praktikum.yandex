(()=>{"use strict";class t{constructor(t){this.TEMPLATE_REGEXP_1=/\{\{(.*?)\}\}/gi,this.TEMPLATE_REGEXP_2=/\{\{\{(.*?)\}\}\}/gi,this._template=t}_compileTemplate(t){let e=this._template,s=null;const n=this.TEMPLATE_REGEXP_1,a=this.TEMPLATE_REGEXP_2;if(void 0===e)throw new Error("Не загружен шаблон");for(;s=a.exec(e);)if(s[1]){const n=s[1].trim();let a=this.getData(t,n);if("function"==typeof a){window[n]=a,e=e.replace(new RegExp(s[0],"gi"),`window.${s[1].trim()}()`);continue}e=e.replace(new RegExp(s[0],"gi"),a||"")}for(;s=n.exec(e);)if(s[1]){const n=s[1].trim();let a=this.getData(t,n);"string"==typeof a&&(a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=a.replace(/"/g,"&quot;"),a=a.replace(/'/g,"&#x27;"),a=a.replace(/`/g,"&#x60;")),e=e.replace(new RegExp(s[0],"gi"),a)}return e}compile(t){return this._compileTemplate(t)}getData(t,e,s=""){const n=e.split(".");let a=t;for(let t of n)if(a=a[t],void 0===a)return s;return null!=a?a:s}}class s{constructor(){this.listeners={},this.listeners={}}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){if(!this.listeners[t])throw new Error(`Нет события: ${t}`);this.listeners[t]=this.listeners[t].filter((t=>t!==e))}emit(t,...e){if(!this.listeners[t])throw new Error(`Нет события: ${t}`);this.listeners[t].forEach((function(t){t(...e)}))}}class n{constructor(t="div",e,a=""){this.eventBus=new s,this.props=this._makePropsProxy(e),this._templateDef=a,this._meta={tagName:t,props:e},this._registerEvents(),this.eventBus.emit(n.EVENTS.INIT)}_registerEvents(){this.eventBus.on(n.EVENTS.INIT,this.init.bind(this)),this.eventBus.on(n.EVENTS.FLOW_CDM,this._componentDidMount.bind(this)),this.eventBus.on(n.EVENTS.FLOW_RENDER,this._render.bind(this)),this.eventBus.on(n.EVENTS.FLOW_CDU,this._componentDidUpdate.bind(this))}_createResources(){let t=this._meta.tagName,e=t,s="",n="";if(-1!=t.indexOf("#")){if(e=t.split("#")[0],s=t.split("#")[1].split(".")[0],t=t.substr(t.indexOf(".")),-1!==t.indexOf(".")){let e=t.split(".");for(let t=0;t<e.length;t++)n+=`${e[t]} `}}else if(-1!==t.indexOf(".")){e=t.split(".")[0];let s=t.split(".");for(let t=1;t<s.length;t++)n+=`${s[t]} `}this.rootElm=document.createElement(e),this.rootElm.setAttribute("id",s),this.rootElm.setAttribute("class",n)}_componentDidMount(){this.eventBus.emit(n.EVENTS.FLOW_RENDER)}_componentDidUpdate(){document.querySelector(this._meta.tagName)&&this.render(),this._attachHandler()}_render(e=this._templateDef){return new t(e).compile(this.props)}_attachHandler(t=this._meta.tagName){if(Array.isArray(this.props.handlers))for(let e of this.props.handlers)for(let s in e)"function"==typeof e[s]&&document.querySelector(t).addEventListener(s,e[s]);else for(let e in this.props.handlers)"function"==typeof this.props.handlers[e]&&document.querySelector(t).addEventListener(e,this.props.handlers[e])}_makePropsProxy(t){return new Proxy(this,{get(e,s){if(0===s.indexOf("_"))throw new Error("error");return e[s]?e[s]:t[s]},set(t,e,s){if(0===e.indexOf("_"))throw new Error("error");return t[e]=s,t[e]},deleteProperty(){throw new Error("error")}})}_createDocumentElement(t){return document.createElement(t)}_getElement(e){let s=new t(e).compile(this.props);return this.rootElm.innerHTML=s,this.rootElm.outerHTML}init(){this._createResources(),this.eventBus.emit(n.EVENTS.FLOW_CDM)}setProps(t={}){return this.props=t,Object.assign(this.props,t),this.eventBus.emit(n.EVENTS.FLOW_CDU),this}get element(){return this._element}render(t,e){if(t)if(document.querySelector(this._meta.tagName)){let s=this._render(e);document.querySelector(this._meta.tagName).innerHTML=s,this.props.handlers&&this._attachHandler(t)}else{let s=this._render(e);this.rootElm.innerHTML=s,document.querySelector(t).append(this.rootElm),this.props.handlers&&this._attachHandler(t)}}getContent(){return this.element}getElement(t=this._templateDef){return this._getElement(t)}}n.EVENTS={INIT:"init",FLOW_CDM:"component-did-mount",FLOW_CDU:"component-did-update",FLOW_RENDER:"render"};class a extends n{constructor(t="main",e,s={}){super(t,s),this._templateDef=e,this.components=s}_registerEvents(){this.eventBus.on(n.EVENTS.INIT,this.init.bind(this)),this.eventBus.on(n.EVENTS.FLOW_CDM,this._componentDidMount.bind(this)),this.eventBus.on(n.EVENTS.FLOW_RENDER,this._render.bind(this)),this.eventBus.on(a.PAGE_EVENTS.PAGE_WAS_RENDER,this._pageWasRender.bind(this)),this.eventBus.on(n.EVENTS.FLOW_CDU,this._componentDidUpdate.bind(this))}_render(e=this._templateDef){let s=new t(e),n={};for(let t in this.components)"handlers"!==t&&(n[t]=this.components[t].getElement());return s.compile(n)}_pageWasRender(){const t=this.props.handlers;t&&t.forEach((t=>{for(let e in t)"render"===e&&t[e]()}))}render(){let t=this._render(this._templateDef);this.rootElm.innerHTML=t,document.querySelector("body").append(this.rootElm);for(let t in this.components)"handlers"!==t&&this.components[t].eventBus.emit(n.EVENTS.FLOW_CDU);this.eventBus.emit(a.PAGE_EVENTS.PAGE_WAS_RENDER)}}a.PAGE_EVENTS={PAGE_WAS_RENDER:"page_render"};class i extends n{constructor(t,e,s='<form action="#" data-form_type={{formType}} enctype="multipart/form-data" class="form-registration bg_dark-gradient2">\n                <h1 class="form-registration__title text-light-max">\n                    {{title}}\n                </h1>\n                <p class="backend-alerts"></p>\n                {{{inputfile}}}\n                {{{inputs}}}\n                <div class="form-registration__input-group">\n                    {{{button}}}\n                    {{{additional}}} \n                </div>\n            </form>'){super(t,e,s)}_attachHandler(t){t||(t=this._meta.tagName);for(let e of this.props.handlers)for(let s in e)"function"==typeof e[s]&&("focus"===s||"blur"===s?document.querySelectorAll(t+" input").forEach((t=>{t.addEventListener(s,e[s])})):"submit"===s?document.querySelector(t+" form").addEventListener("submit",e[s]):document.querySelector(t).addEventListener(s,e[s]))}}class r extends n{constructor(t,e,s='<div class="form-registration__input-group">\n                <input type="{{type}}" name="{{name}}" placeholder="{{label}}" autocomplete="off" class="form-registration__input-group-item bg_dark-min border_light-min text-light-max">\n                <span data-label="{{label}}" class="form-registration__input-group-item_label text-light-max">{{label}}</span>\n            </div>'){super(t,e,s),this._element=null}_getElement(e){let s=new t(e),n="";for(let t=0;t<this.props.length;t++)n+=s.compile(this.props[t]);return this.rootElm.innerHTML=n,this.rootElm.outerHTML}setProps(t){return this.props=t,this.eventBus.emit(n.EVENTS.FLOW_CDU),this}render(e){e||(e=this._meta.tagName);let s=new t(this._templateDef),n="";for(let t=0;t<this.props.length;t++)n+=s.compile(this.props[t]);document.querySelector(e).innerHTML=n}getElement(t=this._templateDef){return this._getElement(t)}}class o extends n{constructor(t,e,s='<button type="submit" class="form-registration__input-group-item-btn bg_dark-min text-light-max" >{{text}}</button>'){super(t,e,s)}_getElement(e){return new t(e).compile(this.props)}getElement(t=this._templateDef){return this._getElement(t)}}class l extends n{constructor(t,e,s='<a href="{{link}}" data-route="{{link}}" class="form-registration__input-group-enter text-light-max" >{{text}}</a>'){super(t,e,s)}_getElement(e){return new t(e).compile(this.props)}getElement(t=this._templateDef){return this._getElement(t)}}class c{registration(t){if(void 0!==t)return window.APPTransport.post(c._registrationURL,{data:JSON.stringify(t)}).then((t=>200===t.status||JSON.parse(t.response).reason))}authorization(t){if(void 0!==t)return window.APPTransport.post(c._authorizationURL,{data:JSON.stringify(t)}).then((t=>200===t.status||JSON.parse(t.response).reason))}getUserDetails(){return window.APPTransport.get(c._userDetailURL).then((t=>200===t.status&&JSON.parse(t.response))).catch((t=>{console.log(t)}))}checkAuthorization(){return window.APPTransport.get(c._userDetailURL).then((t=>200===t.status&&(!!JSON.parse(t.response).id||void 0))).catch((t=>{console.log(t)}))}updateUserDetails(t){const e={},s={},n={},a=[];for(let a in t)"avatar"===a?e[a]=t[a]:"newPassword"===a||"oldPassword"===a?s[a]=t[a]:n[a]=t[a];return 0!==Object.keys(e).length&&a.push(window.APPTransport.put(c._changeUserAvatar,{data:e.avatar,headers:"Content-Type: multipart/form-data"})),0!==Object.keys(s).length&&a.push(window.APPTransport.put(c._changeUserPassword,{data:JSON.stringify(s)})),0!==Object.keys(n).length&&a.push(window.APPTransport.put(c._changeUserDetails,{data:JSON.stringify(n)})),Promise.allSettled(a).then((t=>{let e=[];return t.forEach((t=>{200!==t.value.status&&e.push(t.value.response)})),0===e.length||e}))}logout(){return window.APPTransport.post(c._logout).then((t=>200===t.status)).catch((t=>{console.log(t)}))}}c._baseDomain="https://ya-praktikum.tech",c._authorizationURL=c._baseDomain+"/api/v2/auth/signin",c._registrationURL=c._baseDomain+"/api/v2/auth/signup",c._userDetailURL=c._baseDomain+"/api/v2/auth/user",c._logout=c._baseDomain+"/api/v2/auth/logout",c._changeUserDetails=c._baseDomain+"/api/v2/user/profile",c._changeUserPassword=c._baseDomain+"/api/v2/user/password",c._changeUserAvatar=c._baseDomain+"/api/v2/user/profile/avatar";const u=/[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/,d=/[a-z]/,h="no-valid",m="Без Имени сюда не пустят",p="Без Логина сюда не пустят",_="Телефон не может содержать символы [a-z]",g="Введите корректный email",f="Пароль не может быть короче 1 символов",v="Пароль не совпадает",E="Введите пароль",b=".backend-alerts",x={validate_first_name:function(t){const e=t;if(e.value.length<1){const t=e.nextElementSibling;return t.innerText=m,t.classList.add(h),e.classList.add(h),!1}return!0},validate_display_name:function(t){const e=t;if(e.value.length<1){const t=e.nextElementSibling;return t.innerText=m,t.classList.add(h),e.classList.add(h),!1}return!0},validate_second_name:function(t){const e=t;if(e.value.length<1){const t=e.nextElementSibling;return t.innerText=m,t.classList.add(h),e.classList.add(h),!1}return!0},validate_login:function(t){const e=t;if(e.value.length<1){const t=e.nextElementSibling;return t.innerText=p,t.classList.add(h),e.classList.add(h),!1}return!0},validate_email:function(t){const e=t;if(!u.test(e.value.toLowerCase())){const t=e.nextElementSibling;return t.innerText=g,t.classList.add(h),e.classList.add(h),!1}return!0},validate_phone:function(t){const e=t;if(d.test(e.value.toLowerCase())||e.value.length<3){const t=e.nextElementSibling;return t.innerText=_,t.classList.add(h),e.classList.add(h),!1}return!0},validate_password:function(t){const e=t;if(e.value.length<1){const t=e.nextElementSibling;return t.innerText=f,t.classList.add(h),e.classList.add(h),!1}return!0},validate_password_repeat:function(t){const e=t,s=document.querySelector('input[name="password"]');if(e.value!==s.value){const t=e.nextElementSibling;return t.innerText=v,t.classList.add(h),e.classList.add(h),!1}return!0},validate_avatar:function(t){if(t)return!0},validate_oldPassword:function(t){if(t)return!0},validate_newPassword:function(t){const e=t,s=document.querySelector('input[name="oldPassword"]');if(e.value.length>0&&s.value.length<1){const t=s.nextElementSibling;return t.innerText=E,t.classList.add(h),s.classList.add(h),!1}if(e.value.length<1&&s.value.length>0){const t=e.nextElementSibling;return t.innerText=E,t.classList.add(h),e.classList.add(h),!1}return!0}},w={authorization:function(t,e){(t||e)&&(new c).authorization(e).then((t=>{if(!0!==t){if(document.querySelector(b)){const e=document.querySelector(b);void 0!==t&&(e.textContent=t.toString())}}else window.location.href="/chats"})).catch((t=>{console.log(t),document.querySelector(b)&&(document.querySelector(b).textContent=t.message)}))},registration:function(t,e){(t||e)&&void 0!==e&&(new c).registration(e).then((t=>{!0!==t?document.querySelector(b)&&(document.querySelector(b).textContent=t||""):window.location.href="/chats"})).catch((t=>{document.querySelector(b)&&(document.querySelector(b).textContent=t.message)}))},userSettings:function(t,e){if(!t&&!e)return;const s=new c;if(0!==e.avatar.length){const t=new FormData,s=document.querySelector('input[name="avatar"]');if(s&&s.files){const n=s.files[0];t.append("avatar",n),e.avatar=t}}s.updateUserDetails(e).then((t=>{if(!0!==t){let e="";if(Array.isArray(t)){if(t.forEach((t=>{e+=t+" "})),document.querySelector(b)){const t=document.querySelector(b);t&&(t.textContent=e)}}else if(document.querySelector(b)){const e=document.querySelector(b);void 0!==t&&(e.textContent=t)}y()}else y()})).catch((t=>{if(document.querySelector(b)){const e=document.querySelector(b);e&&(e.textContent=t.message)}}))}};function y(){(new c).getUserDetails().then((t=>{for(let e in t)if(document.querySelector(`input[name=${e}]`))if("avatar"===e&&t[e]){const s=document.querySelector(`input[name=${e}]`);s.parentElement&&(s.parentElement.style.backgroundImage=`url(https://ya-praktikum.tech/${t[e]})`)}else{const s=document.querySelector(`input[name=${e}]`);s&&t[e]&&(s.value=t[e].toString())}}))}function T(t){const e=t.target;x[`validate_${e.name}`](e)}function S(t){t.preventDefault();const e=t.currentTarget,s=e.dataset.form_type,n=e.querySelectorAll("input"),a=[],i={};n.forEach((t=>{x[`validate_${t.name}`](t)?i[t.name]=t.value:a.push(t.name)})),0===a.length&&(s?w[s](e,i):window.location.href="/error")}function k(t){const e=t.target;e.classList.remove(h);const s=e.nextElementSibling;if(s){s.classList.remove(h);const t=s.dataset.label;s.textContent=t||""}}const L=new l("div#logIn-component",{text:"Забыли пароль",link:"#"}).getElement(),P=new l("div#logIn-component",{text:"Регистрация",link:"/registration"}).getElement();let D=new i("div#form-component",{title:"Авторизация",formType:"authorization",inputs:new r("div#input-component",[{type:"text",label:"Логин",name:"login"},{type:"text",label:"Пароль",name:"password"}]).getElement(),button:new o("div#btn-component",{text:"Войти"}).getElement(),additional:L+P,handlers:[{blur:T},{input:k},{submit:S}]}),O=new a("main.container",'<div id="authorization-page">\n                {{{form}}}\n            </div>',{form:D});class R extends n{constructor(t,e,s='<div class="mobile-close separator-dark">\n            <div class="mobile-close__txt text-light-min">\n                <span>Закрыть</span>\n            </div>\n        </div>\n        <div class="user-list-search separator-dark">\n            <div class="user-list-search__group">\n                <input class="user-list-search__input bg_dark-min border_light-min text-light-max" type="text" name="{{search_type}}" >\n                <i class=\'fas fa-search text-light-min\'></i>\n            </div>\n        </div>'){super(t,e,s)}}class A extends c{constructor(){super(...arguments),this._users=[{}],this._chatRooms=[{}]}searchUsers(t){return window.APPTransport.post(A._userSearch,{data:JSON.stringify({login:t})}).then((t=>{if(200!==t.status)return JSON.parse(t.response).reason;{let e=JSON.parse(t.response);return e.forEach((t=>{for(let e in t)"avatar"===e&&(t[e]=c._baseDomain+t[e])})),e}})).catch((t=>{console.log(t)}))}getAllChatRooms(){return window.APPTransport.get(A._allChats).then((t=>this._chatRooms=JSON.parse(t.response))).catch((t=>{console.log(t)}))}getUsersinChatRooms(t){return t?window.APPTransport.get(`https://ya-praktikum.tech/api/v2/chats/${t}/users`):Promise.reject(!1)}createSingleChatRoom(t){return window.APPTransport.post(A._createChat,{data:JSON.stringify({title:t})}).then((t=>200===t.status)).catch((t=>{console.log(t)}))}addUserToChatRoom(t,e){return window.APPTransport.put(A._addUsertoChat,{data:JSON.stringify({users:[t],chatId:e})}).then((t=>200===t.status)).catch((t=>{console.log(t)}))}removeUserFromChatRoom(t,e){return window.APPTransport.delete(A._addUsertoChat,{data:JSON.stringify({users:[t],chatId:e})}).then((t=>200===t.status)).catch((t=>{console.log(t)}))}getUserByID(t){return window.APPTransport.get(`https://ya-praktikum.tech/api/v2/user/${t}`).then((t=>t.response)).catch((t=>{console.log(t)}))}}A._userSearch="https://ya-praktikum.tech/api/v2/user/search",A._allChats="https://ya-praktikum.tech/api/v2/chats",A._createChat="https://ya-praktikum.tech/api/v2/chats",A._addUsertoChat="https://ya-praktikum.tech/api/v2/chats/users";class q extends n{constructor(t,e,s='<a data-chat_include="remove" data-user_id="{{user_id}}" data-user_login="{{user_login}}" href="" class="user-list__item-info-name-link text-light-max" ><i class="fas fa-user-minus"></i></a>'){super(t,e,s)}getElement(t=this._templateDef){return super._getElement(t)}}class N extends n{constructor(t,e,s='<a data-chat_include="add" data-user_id="{{user_id}}" data-user_login="{{user_login}}" href="" class="user-list__item-info-name-link text-light-max" ><i class="fas fa-user-plus"></i></a>'){super(t,e,s)}getElement(t=this._templateDef){return super._getElement(t)}}function C(){let t=window.location.href.split("?chatid=");return t=t[t.length-1],-1!==t.indexOf("&")&&(t=t.split("#")[0]),-1!==t.indexOf("#")&&(t=t.split("#")[0]),t}function U(){document.querySelector(".chat-top__items-menu-starter").classList.toggle("z-25"),document.querySelector(".chat-top__items-menu").classList.toggle("open"),document.querySelector(".mobile-wrapper").classList.toggle("active")}function M(){document.addEventListener("click",(t=>{t.target.classList.contains("logout-link")&&(new c).logout().then((t=>{!0===t&&console.log("Succes")}))}))}function H(){const t=this;(new A).getAllChatRooms().then((e=>{t.setProps(e)}))}let B=new class extends n{constructor(t,e,s,n='<div class="user-list__item separator-dark {{active}}">\n                <div style="background-image: url({{avatar}})" class="user-list__item-avatar bg_light-min border_light-max no-avatar">\n                    <span href=""  data-chat_id="{{id}}" class="user-list__item-avatar-link"></span>\n                </div>\n                <div class="user-list__item-info">\n                    <p class="user-list__item-info-name"><a href="" data-route="/chat?chatid={{id}}" data-chat_id="{{id}}"  class="user-list__item-info-name-link text-light-max">{{title}}</a></p>\n                    <p class="user-list__item-info-last-msg"><a href="/chat?chatid={{id}}"  data-route="/chat?chatid={{id}}" data-chat_id="{{id}}" class="user-list__item-info-last-msg-link text-light-min">{{excerpt}}</a></p>\n                </div>\n                <div class="user-list__item-actions">\n                    <span class="user-list__item-actions-newmsg"><a href="/chat?chatid={{id}}" data-route="/chat?chatid={{id}}" data-chat_id="{{id}}"  class="new-msg-background text-light " >{{msg_amount}}1</a></span>\n                </div>\n            </div>'){super(t,e,n),this._element=null,this.activeClass=s}_getElement(e=this._templateDef){let s=new t(e),n="";for(let t=0;t<this.props.length;t++)n+=s.compile(this.props[t]);return this.rootElm.innerHTML=n,this.rootElm.outerHTML}setProps(t){this.props=t;for(let t=0;t<this.props.length;t++)!0===this.props[t].active?this.props[t].active=this.activeClass:this.props[t].active="";return this.eventBus.emit(n.EVENTS.FLOW_CDU),this}render(e){e||(e=this._meta.tagName);let s=new t(this._templateDef),n="";for(let t=0;t<this.props.length;t++)n+=s.compile(this.props[t]);document.querySelector(e).innerHTML=n}getElement(t){return this._getElement(t)}}("div#userList-component",[{avatar:"",id:"",title:"",excerpt:"",msg_amount:""}],"current-user"),z=new R("div#searchBlock-component",{search_type:"search-chats"}),F=new class extends n{constructor(t,e,s='<span class="text-light-min chat-alert__select">{{alert_msg}}</span>'){super(t,e,s)}}("div.chat-alert",{alert_msg:"Выберите чат"}),W=new class extends n{constructor(t,e,s='\n                <div class="modal_body">\n                    <div class="modal-msg-group">\n                        <input type="text" data-action="chat-name" class="modal-msg-group__input bg_dark-min border_light-min text-light-max"  />                \n                        <a href="" data-action="chat-creator" class="modal-msg-group__send">\n                            <i data-action="chat-creator" class="fas fa-angle-right text-light-min"></i>\n                        </a>\n                    </div>\n                </div>          \n            '){super(t,e,s)}getElement(t=this._templateDef){return super._getElement(t)}}("div#addchat.modal.bg_dark-gradient",{}),V=new class extends n{constructor(t,e,s='<div class="chat-top__items-menu-starter">\n                <div class="chat-top-menu__link">\n                    <i class="fas fa-chevron-down fa-2x text-light-min"></i>\n                </div>\n            </div>\n            <div class="chat-top__items-menu bg_dark-gradient">\n                <ul class="chat-top__items-menu_list" >\n                    <li class="chat-top__items-menu_list-item separator-dark"><a href="/settings" data-route="/settings" class="text-light-max" ><i class="fas fa-cog"></i>Настройки профиля <span id="loggin"></span></a></li>\n                    <li class="chat-top__items-menu_list-item separator-dark"><a href="" data-target="modal" data-modal="#addchat" class="text-light-max" ><i class="fas fa-plus"></i>Новый чат</a></li>\n                    <li class="chat-top__items-menu_list-item separator-dark text-light-max"><a href="/auth"  data-route="/auth" class="text-light-max logout-link" ><i class="fas fa-door-open"></i> Выход </a></li>\n                </ul>\n            </div>'){super(t,e,s)}}("div#chatMenu-component",{handlers:[{click:U},{click:M}]}),$=new a("main.container",'<div class="user-list bg_dark-gradient">\n                <div class="search-block">\n                    {{{search_block}}}\n                </div>\n                <div class="user-collection-block">\n                    {{{user_collection_block}}}\n                </div>\n            </div>\n            <div class="chat">\n            <div class="chat-top bg_dark">\n                    <div class="chat-top__items separator-dark">\n                        <div class="chat-top__items-mobile-list">\n                            <a href="" class="chat-top-mobile-user-list">\n                                <i class="fas fa-bars fa-2x text-light-min mobile-menu-starter"></i>\n                            </a>\n                        </div>\n                        <div class="chat-top__items-details">\n                           \n                        </div>\n                        {{{chat_menu}}}\n                    </div>\n                </div>\n                {{{chat_alert}}}\n            </div>\n{{{modal}}}\n',{search_block:z,user_collection_block:B,chat_menu:V,chat_alert:F,modal:W,handlers:[{render:H.bind(B)},{render:function(){const t=this;document.addEventListener("click",(e=>{if("chat-creator"===e.target.dataset.action){e.preventDefault();const s=document.querySelector('input[data-action="chat-name"]').value;s&&s.length>0&&(document.querySelector('input[data-action="chat-name"]').value="",(new A).createSingleChatRoom(s).then((e=>{!0===e&&(H.bind(t)(),document.querySelector(".mobile-wrapper").classList.remove("active"),document.querySelector(".user-list").classList.remove("open"),document.querySelector(".chat-top__items-menu").classList.remove("open"),document.querySelector(".modal").classList.remove("open"),document.querySelector(".chat-bottom__items-menu")&&document.querySelector(".chat-bottom__items-menu").classList.remove("open"),document.querySelectorAll(".z-25").forEach((t=>{t.classList.remove("z-25")})))})))}}))}.bind(B)}]});class j extends n{constructor(t,e,s='<span class="msg-meta-status"><i class="fas fa-check"></i><i class="fas fa-check"></i></span>'){super(t,e,s)}getElement(t=this._templateDef){return super._getElement(t)}}let I=new class extends n{constructor(t,e,s,n='<div class="user-list__item separator-dark {{active}}">\n                <div style="background-image: url({{avatar}})" class="user-list__item-avatar bg_light-min border_light-max no-avatar">\n                    <a href="" data-user_id="{{id}}" class="user-list__item-avatar-link"></a>\n                </div>\n                <div class="user-list__item-info">\n                    <p class="user-list__item-info-name"><a href="" data-user_id="{{id}}"  class="user-list__item-info-name-link text-light-max">{{login}}</a> {{{add_remove_chat}}} </p>\n                    <p class="user-list__item-info-last-msg"><a href="" data-user_id="{{id}}" class="user-list__item-info-last-msg-link text-light-min">{{excerpt}}</a></p>\n                </div>\n                <div class="user-list__item-actions">\n                    <span class="user-list__item-actions-time text-light-max">{{time}}</span>\n                    <span class="user-list__item-actions-newmsg"><a href="" data-user_id="{{id}}"  class="new-msg-background text-light " >{{msg_amount}}</a></span>\n                </div>\n            </div>'){super(t,e,n),this._element=null,this.activeClass=s}_getElement(e=this._templateDef){let s=new t(e),n="";for(let t=0;t<this.props.length;t++)n+=s.compile(this.props[t]);return this.rootElm.innerHTML=n,this.rootElm.outerHTML}setProps(t){this.props=t;for(let t=0;t<this.props.length;t++)!0===this.props[t].active?this.props[t].active=this.activeClass:this.props[t].active="";return this.eventBus.emit(n.EVENTS.FLOW_CDU),this}render(e){e||(e=this._meta.tagName);let s=new t(this._templateDef),n="";for(let t=0;t<this.props.length;t++)n+=s.compile(this.props[t]);document.querySelector(e).innerHTML=n}getElement(t){return this._getElement(t)}}("div#userList-component",[{avatar:"",login:"",active:""}],"current-user"),J=new class extends n{constructor(t,e,s='<div class="chat-messages__item_{{user}}">\n                <div class="text-wrapper text-light-max bg_dark-min">{{content}}\n                    <div class="chat-messages__item_other-meta msg-meta">  \n                        {{{delivered}}}   \n                        <span class="msg-meta-time text-light-min" >{{time}}</span>\n                    </div>\n                </div>\n            </div>'){super(t,e,s),this._element=null,this.actualize(e)}_getElement(e=this._templateDef){let s=new t(e),n="";for(let t=0;t<this.props.length;t++)n+=s.compile(this.props[t]);return this.rootElm.innerHTML=n,this.rootElm.outerHTML}setProps(t){this.props=t;for(let t=0;t<this.props.length;t++)1===this.props[t].user?this.props[t].user="self":this.props[t].user="other",!0===this.props[t].delivered?this.props[t].delivered=new j("div",{}).getElement():this.props[t].delivered="";return this.eventBus.emit(n.EVENTS.FLOW_CDU),this}render(e){e||(e=this._meta.tagName);let s=new t(this._templateDef),n="";for(let t=0;t<this.props.length;t++)n+=s.compile(this.props[t]);document.querySelector(e).innerHTML=n}getElement(t){return this._getElement(t)}actualize(t){if(t){this.props=t;for(let t=0;t<this.props.length;t++)1===this.props[t].user?this.props[t].user="self":this.props[t].user="other",!0===this.props[t].delivered?this.props[t].delivered=new j("div",{}).getElement():this.props[t].delivered="";return this}}}("div#messagelist-component",[{content:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Assumenda autem cumque cupiditate earum eos et facere, maiores necessitatibus nulla odit officiis placeat porro, quibusdam reprehenderit sunt tempore voluptatem. Consectetur, pariatur!",time:"10:00",user:0},{content:"Text text text",time:"11:00",user:0},{content:"lorem xsx",time:"13:00",user:1,delivered:!0}]),G=new R("div#searchBlock-component",{search_type:"search-users"}),Q=new class extends n{constructor(t,e,s='<div class="chat-bottom__items separator-dark-top">\n           \n                {{{send_message}}}\n                \n                {{{attach_menu}}}\n              \n            </div>'){super(t,e,s)}}("div#sendMessageGroup-component",{send_message:new class extends n{constructor(t,e,s='<div class="chat-bottom__items-add">\n                    <div class="chat-bottom__items-add-attach">\n                        <i class="fas fa-paperclip attach-menu-starter text-light-min"></i>\n                    </div>\n                    <div class="chat-bottom__items-add-emodji">\n                        <i class="far fa-smile text-light-min"></i>\n                    </div>\n                </div>\n                <div class="chat-bottom__items-msg">\n                    <div class="chat-bottom__items-msg-group">\n                        <div id="message" class="chat-bottom__items-msg-input bg_dark-max border_light-min text-light-max" contenteditable="true" data-tab="1" dir="ltr" spellcheck="true" ></div>\n                        <a href="" class="chat-bottom__items-msg-send">\n                            <i class="fas fa-angle-right text-light-min"></i>\n                        </a>\n                    </div>\n                </div>'){super(t,e,s)}_getElement(e=this._templateDef){return new t(e).compile(this.props)}getElement(t=this._templateDef){return this._getElement(t)}}("div#sendMessage-component",{}).getElement(),attach_menu:new class extends n{constructor(t,e,s='<div class="chat-bottom__items-menu bg_dark-gradient">\n                <ul class="chat-bottom__items-menu_list" >\n                    <li class="chat-bottom__items-menu_list-item separator-dark text-light-max"><i class="far fa-image"></i>Изображение</li>\n                    <li class="chat-bottom__items-menu_list-item separator-dark text-light-max"><i class="fas fa-sd-card"></i>Файл</li>\n                    <li class="chat-bottom__items-menu_list-item separator-dark text-light-max"><i class="fas fa-map-marker-alt"></i>Локация</li>\n                </ul>\n            </div>'){super(t,e,s)}}("div#attachMenu-component",{}).getElement(),handlers:[{click:function(t){t.target.classList.contains("attach-menu-starter")&&(document.querySelector(".chat-bottom__items-add-attach").classList.toggle("z-25"),document.querySelector(".chat-bottom__items-menu").classList.toggle("open"),document.querySelector(".mobile-wrapper").classList.toggle("active"))}}]}),X=new class extends n{constructor(t,e,s='<div class="chat-top__items-details_group">\n                <div style="background-image: url({{photo}})" class="chat-top__items-details_group-ava border_light-max">\n                    <a href="" class="chat-top__items-details_group-ava-link"></a>\n                </div>\n                <div class="chat-top__items-details_group-name">\n                    <a class="chat-top__items-details_group-name_link text-light-max" href="{{link}}">\n                           {{name}}\n                    </a>\n                    <span class="chat-top__items-details_group-name-visit text-light-min">{{lastTime}}</span>\n                </div>\n            </div>'){super(t,e,s)}}("div#chatDetails-component",{name:"Андрей",lastTime:"Был 1 минуту назад",photo:"https://cdn.pixabay.com/photo/2016/11/18/19/07/happy-1836445_1280.jpg",link:"#"}),K=new class extends n{constructor(t,e,s='<div class="chat-top__items-menu-starter">\n                <div class="chat-top-menu__link">\n                    <i class="fas fa-chevron-down fa-2x text-light-min"></i>\n                </div>\n            </div>\n            <div class="chat-top__items-menu bg_dark-gradient">\n                <ul class="chat-top__items-menu_list" >\n                    <li class="chat-top__items-menu_list-item separator-dark"><a href="/settings" data-route="/settings" class="text-light-max" ><i class="fas fa-cog"></i>Настройки профиля <span id="loggin"></span></a></li>\n                    <li class="chat-top__items-menu_list-item separator-dark"><a href="/chats" data-route="/chats" class="text-light-max" ><i class="far fa-comment-dots"></i>К списку чатов<span id="loggin"></span></a></li>                   \n                    <li class="chat-top__items-menu_list-item separator-dark text-light-max"><a href="/auth"  data-route="/auth" class="text-light-max logout-link" ><i class="fas fa-door-open"></i> Выход </a></li>\n                </ul>\n            </div>'){super(t,e,s)}}("div#chatMenu-component",{handlers:[{click:U},{click:M}]}),Y=new a("main.container",'<div class="user-list bg_dark-gradient">\n                <div class="search-block">\n                    {{{search_block}}}\n                </div>\n                <div class="user-collection-block">\n                    {{{user_collection_block}}}\n                </div>\n            </div>\n            <div class="chat">\n                <div class="chat-top bg_dark">\n                    <div class="chat-top__items separator-dark">\n                        <div class="chat-top__items-mobile-list">\n                            <a href="" class="chat-top-mobile-user-list">\n                                <i class="fas fa-bars fa-2x text-light-min mobile-menu-starter"></i>\n                            </a>\n                        </div>\n                        <div class="chat-top__items-details">\n                           {{{chat_deatails}}}\n                        </div>\n                        {{{chat_menu}}}\n                    </div>\n                </div>\n                <div class="chat-messages">\n                    {{{messages}}}            \n                </div>\n                <div class="chat-bottom bg_dark">\n                    {{{send_message_group}}}\n                </div>\n            </div>',{search_block:G,user_collection_block:I,send_message_group:Q,chat_deatails:X,chat_menu:K,messages:J,handlers:[{render:function(){const t=this;document.addEventListener("input",(e=>{if("search-users"===e.target.name){const s=new A;if(e.target.value.length>0)s.searchUsers(e.target.value,t,C()).then((e=>s.getUsersinChatRooms(C()).then((s=>{for(let t=0;t<e.length;t++){for(let n=0;n<s.length;n++)e[t].id===s[n].id&&(e[t].add_remove_chat=new q("span.remove-from-chat",{user_id:e[t].id,user_login:e[t].login}).getElement());e[t].add_remove_chat||(e[t].add_remove_chat=new N("span.add-to-chat",{user_id:e[t].id,user_login:e[t].login}).getElement())}t.setProps(e)}))));else{const e=C();s.getUsersinChatRooms(e).then((e=>{t.setProps(e)}))}}}))}.bind(I)},{render:function(){const t=this,s=new A,n=C();s.getUsersinChatRooms(n).then((t=>{let e=JSON.parse(t.response);e.forEach((t=>{t.avatar=c._baseDomain+t.avatar,t.add_remove_chat=new q("span.remove-from-chat",{user_id:t.id,user_login:t.login}).getElement()}));const s=[e[0]];for(let t=0;t<e.length;t++){let n=!1;for(let a=0;a<s.length;a++)if(e[t].id===s[a].id){n=!0;break}!1===n&&s.push(e[t])}return s})).then((e=>{t.setProps(e)})).catch((()=>{console.log(e)}))}.bind(I)},{render:M},{render:function(){document.addEventListener("click",(t=>{if(t.preventDefault(),t.target.hasAttribute("data-chat_include")||t.target.parentElement.hasAttribute("data-chat_include")){const e=t.target.hasAttribute("data-chat_include")?t.target:t.target.parentElement,s=e.dataset.chat_include,n=e.dataset.user_id,a=C();"add"===s?(new A).addUserToChatRoom(n,a).then((t=>{!0===t&&(e.setAttribute("data-chat_include","remove"),e.innerHTML='<i class="fas fa-user-minus" aria-hidden="true"></i>')})):"remove"===s&&(new A).removeUserFromChatRoom(n,a).then((t=>{!0===t&&(e.setAttribute("data-chat_include","add"),e.innerHTML='<i class="fas fa-user-plus" aria-hidden="true"></i>')}))}}))}}]}),Z=new i("div#form-component",{title:"Регистрация",formType:"registration",inputs:new r("div#input-component",[{type:"text",label:"Имя",name:"first_name"},{type:"text",label:"Фамилия",name:"second_name"},{type:"text",label:"Логин",name:"login"},{type:"email",label:"email",name:"email"},{type:"number",label:"Телефон",name:"phone"},{type:"text",label:"Пароль",name:"password"}]).getElement(),button:new o("div#btn-component",{text:"Зарегистрироваться"}).getElement(),additional:new l("div#logIn-component",{text:"Войти",link:"/auth"}).getElement(),handlers:[{blur:T},{input:k},{submit:S}]}),tt=new a("main.container",'<div id="registration-page">\n                {{{form}}}\n            </div>',{form:Z}),et=new i("div#form-component",{title:"Настройки пользователя",formType:"userSettings",inputfile:new class extends n{constructor(t,e,s='<div class="form-user-settings__ava-group">      \n                <div class="form-user-settings__ava-group-upload upload-img-group">\n                    <label style="background-image: url({{photo}})" class="upload-img-group__img border_light-max">\n                        <input type="file" name="{{name}}" class="upload-img-group__uploader">\n                    </label>\n                </div>\n            </div>'){super(t,e,s),this._element=null}_getElement(e){let s=new t(e).compile(this.props);return this.rootElm.innerHTML=s,this.rootElm.outerHTML}setProps(t){return this.props=t,this.eventBus.emit(n.EVENTS.FLOW_CDU),this}render(e){e||(e=this._meta.tagName);let s=new t(this._templateDef).compile(this.props);document.querySelector(e).innerHTML=s}getElement(t=this._templateDef){return this._getElement(t)}}("div#input-file-component",{photo:"",name:"avatar"}).getElement(),inputs:new r("div#input-component",[{type:"text",label:"Имя",name:"first_name"},{type:"text",label:"Ник",name:"display_name"},{type:"text",label:"Фамилия",name:"second_name"},{type:"email",label:"email",name:"email"},{type:"number",label:"Телефон",name:"phone"},{type:"text",label:"Логин",name:"login"},{type:"text",label:"Пароль старый",name:"oldPassword"},{type:"text",label:"Пароль новый",name:"newPassword"}]).getElement(),button:new o("div#btn-component",{text:"Сохранить"}).getElement(),additional:"",handlers:[{blur:T},{input:k},{submit:S}]}),st=new a("main.container",'<div id="user-settings-page">\n                {{{form}}}\n            </div>',{form:et,handlers:[{render:y}]}),nt=new a("main.container",'<div class="error-msg">\n            {{{error_block}}}\n            </div>',{error_block:new class extends n{constructor(t,e,s='<h1 class="error-msg__code text-light-max">{{code}}</h1>\n            <h3 class="error-msg__text text-light-max">{{text}}</h3>'){super(t,e,s)}}("div#error-block",{code:"404",text:"Страница не найдена"})});class at{constructor(){this.url="",this.get=(t,e={})=>(this.url=t,0!==Object.keys(e).length&&(e.data=this.queryStringify(e.data)),this.request(Object.assign(Object.assign({},e),{method:at.METHODS.GET}),e.timeout).then((t=>{if(!t)throw new Error("Ошибка HTTPTransport");return t}))),this.put=(t,e={})=>(this.url=t,this.request(Object.assign(Object.assign({},e),{method:at.METHODS.PUT}),e.timeout).then((t=>{if(!t)throw new Error("Ошибка HTTPTransport");return t}))),this.post=(t,e={})=>(this.url=t,this.request(Object.assign(Object.assign({},e),{method:at.METHODS.POST}),e.timeout).then((t=>{if(!t)throw new Error("Ошибка HTTPTransport");return t}))),this.delete=(t,e={})=>(this.url=t,this.request(Object.assign(Object.assign({},e),{method:at.METHODS.DELETE}),e.timeout).then((t=>{if(!t)throw new Error("Ошибка HTTPTransport");return t}))),this.request=(t={},e)=>{const{method:s,data:n="",headers:a}=t;return new Promise(((t,i)=>{const r=new XMLHttpRequest;r.withCredentials=!0,s===at.METHODS.GET?r.open(s,this.url+n):r.open(s,this.url),a||r.setRequestHeader("Content-Type","application/json"),e&&(r.timeout=e),r.onload=function(){t(r)},r.onerror=t,r.ontimeout=t,r.onabort=i,s!==at.METHODS.GET&&n?r.send(n):r.send(null)}))}}queryStringify(t){if("object"!=typeof t)return;let e="";for(let s in t)e+=this._recursQueryStringCreator(t[s],"",s);return"&"===e[e.length-1]&&(e=e.substring(0,e.length-1)),`?${e}`}_recursQueryStringCreator(t,e,s=""){let n=s;if("object"==typeof t)for(let a in t)e=this._recursQueryStringCreator(t[a],e,s+=`[${a}]`),s=n;else e+=`${s}=${t}&`;return e}}at.METHODS={GET:"GET",PUT:"PUT",POST:"POST",DELETE:"DELETE"};const it={HOOKS:{APP_START:"APP_START",APP_FATAL_ERROR:"APP_ERROR",APP_EXIT:"APP_EXIT"},BUS:new s};it.BUS.on(it.HOOKS.APP_START,(function(){window.APPTransport=new at})),it.BUS.on(it.HOOKS.APP_FATAL_ERROR,(function(){throw Error("FATAL ERROR")}));class rt{constructor(t,e,s,n){this._pathname=t,this._blockClass=e,this._block=null,this._props=s,this._parentElement=n}match(t){return t===this._pathname}leave(){this._block&&this._block.hide()}render(){this._block?this._block.show():this._blockClass.render()}leavePage(){document.body.innerHTML='<div class="mobile-wrapper"></div>'}renderPage(){this._blockClass.render()}}class ot{constructor(t={}){if(ot.__instance)return ot.__instance;this.routes=[],this._currentRoute=null,this._rootQuery=t,ot.__instance=this}use(t,e,s={}){const n=new rt(t,e,Object.assign({rootQuery:this._rootQuery},s),ot.__instance._rootQuery);return ot.__instance.routes.push(n),ot.__instance}start(){window.onpopstate=(t=>{if(t.state){let e=JSON.stringify(t.state.page).replace(/"/g,"");this._onRoute(e)}}).bind(this)}_onRoute(t){let e=this.getRoute(this._pathDetector(t));e||(t="/error",e=this.getRoute("/error")),this._currentRoute||(this._currentRoute=this.getRoute("/auth")),e.leavePage(),e.renderPage(),this._currentRoute=this.getRoute(this._pathDetector(t))}go(t){this._authorizationCheck().then((e=>{e||"/registration"===this._pathDetector(t)?(window.history.pushState({page:t},`${t}`,t),this._onRoute(t)):this._onRoute("/auth")}))}back(){window.history.back()}forward(){window.history.forward()}getRoute(t){return ot.__instance.routes.find((e=>e.match(t)))}_authorizationCheck(){return(new c).checkAuthorization()}_pathDetector(t){if(-1!==t.indexOf("?")){const e=(t=(t=t.replace(/#/g,"")).split("?")[0]).split("/");return`/${e[e.length-1]}`}return t}}let lt=window.location.href.split("/"),ct=lt[lt.length-1];ct=ct?`/${ct}`:"/auth";const ut=new ot;ut.use("/auth",O).use("/chats",$).use("/chat",Y).use("/registration",tt).use("/settings",st).use("/error",nt).start(),document.addEventListener("click",(t=>{const e=t.target;if(void 0!==e.dataset.route){t.preventDefault();let s=e.dataset.route;ut.go(s)}})),it.BUS.emit(it.HOOKS.APP_START),ut.go(ct)})();